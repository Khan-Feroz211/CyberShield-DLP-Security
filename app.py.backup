from flask import Flask, render_template, jsonify, send_file, make_response
import json
import csv
from datetime import datetime
from io import StringIO, BytesIO

app = Flask(__name__, static_folder='static', template_folder='templates')

# ==================== SAMPLE DATA ====================
SAMPLE_SCANS = [
    {
        "id": 1,
        "filename": "employee_salaries_2024.xlsx",
        "path": "/corporate/hr/",
        "file_type": "Excel",
        "sensitivity": "High",
        "size_mb": 4.2,
        "scan_date": "2024-01-15 09:30:00",
        "issues": 3,
        "status": "Suspicious",
        "details": "Contains SSN numbers and salary information"
    },
    {
        "id": 2,
        "filename": "customer_database_backup.sql",
        "path": "/backups/db/",
        "file_type": "Database",
        "sensitivity": "Critical",
        "size_mb": 256.7,
        "scan_date": "2024-01-15 10:15:00",
        "issues": 12,
        "status": "Critical",
        "details": "Contains PII data: names, emails, phone numbers"
    },
    {
        "id": 3,
        "filename": "medical_records_encrypted.zip",
        "path": "/healthcare/records/",
        "file_type": "Archive",
        "sensitivity": "High",
        "size_mb": 89.3,
        "scan_date": "2024-01-15 11:45:00",
        "issues": 0,
        "status": "Clean",
        "details": "HIPAA compliant encrypted medical records"
    }
]

SECURITY_ALERTS = [
    {
        "id": "ALT-2024-001",
        "type": "Data Exfiltration",
        "severity": "Critical",
        "description": "Unauthorized export of customer PII data detected",
        "source": "192.168.1.45",
        "timestamp": "2024-01-15 14:25:32",
        "status": "Active",
        "action": "Immediate investigation required"
    },
    {
        "id": "ALT-2024-002",
        "type": "Sensitive Data Exposure",
        "severity": "High",
        "description": "Financial records stored in unencrypted format",
        "source": "File Server FS-01",
        "timestamp": "2024-01-15 11:30:15",
        "status": "Active",
        "action": "Encrypt files and review access"
    }
]

# ==================== ROUTES ====================
@app.route('/')
def home():
    return render_template('dashboard.html')

@app.route('/dashboard')
def dashboard():
    stats = {
        'total_scans': 1245,
        'critical_alerts': 23,
        'sensitive_patterns': 4,
        'data_risk_score': '15.2%',
        'compliance_score': '99.8%',
        'last_scan': SAMPLE_SCANS[-1]['scan_date'] if SAMPLE_SCANS else 'Never'
    }
    return render_template('dashboard.html', stats=stats, scans=SAMPLE_SCANS, alerts=SECURITY_ALERTS)

@app.route('/scanner')
def scanner():
    return render_template('scanner.html', scans=SAMPLE_SCANS)

@app.route('/monitor')
def monitor():
    return render_template('monitor.html', alerts=SECURITY_ALERTS)

@app.route('/alerts')
def alerts():
    return render_template('alerts.html', alerts=SECURITY_ALERTS)

@app.route('/reports')
def reports():
    return render_template('reports.html')

@app.route('/api-testing')
def api_testing():
    return render_template('api_testing.html')

# ==================== API ENDPOINTS ====================
@app.route('/api/health')
def api_health():
    return jsonify({
        "status": "healthy",
        "service": "DLP Security System",
        "version": "2.0.0",
        "timestamp": datetime.now().isoformat()
    })

@app.route('/api/stats')
def api_stats():
    return jsonify({
        "system_stats": {
            "total_scans": 1245,
            "active_alerts": 2,
            "critical_files": 1,
            "compliance_score": "99.8%"
        }
    })

@app.route('/api/sample-data')
def sample_data():
    """Get all sample data for display"""
    return jsonify({
        "scanned_files": SAMPLE_SCANS,
        "security_alerts": SECURITY_ALERTS
    })

@app.route('/api/scan-data')
def scan_data():
    """Get only scanned files data"""
    return jsonify(SAMPLE_SCANS)

@app.route('/api/alert-data')
def alert_data():
    """Get only alert data"""
    return jsonify(SECURITY_ALERTS)

# ==================== REPORT DOWNLOAD ====================
@app.route('/api/report/download/<format>')
def download_report(format='csv'):
    """Download security report in various formats"""
    timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
    
    if format == 'csv':
        output = StringIO()
        writer = csv.writer(output)
        
        writer.writerow(['DLP SECURITY REPORT', f'Generated: {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}'])
        writer.writerow([])
        writer.writerow(['Total Files Scanned', '1245'])
        writer.writerow(['Critical Alerts', '23'])
        writer.writerow(['Compliance Score', '99.8%'])
        
        response = make_response(output.getvalue())
        response.headers['Content-Type'] = 'text/csv'
        response.headers['Content-Disposition'] = f'attachment; filename=dlp_report_{timestamp}.csv'
        return response
    
    elif format == 'json':
        report = {
            "report_id": f"DLP-REPORT-{timestamp}",
            "generated_at": datetime.now().isoformat(),
            "summary": {
                "total_files_scanned": 1245,
                "critical_alerts": 23,
                "compliance_score": "99.8%"
            }
        }
        
        response = make_response(json.dumps(report, indent=2))
        response.headers['Content-Type'] = 'application/json'
        response.headers['Content-Disposition'] = f'attachment; filename=dlp_report_{timestamp}.json'
        return response
    
    else:
        return jsonify({"error": "Invalid format. Use 'csv' or 'json'"}), 400

@app.route('/api/report/quick')
def quick_report():
    """Generate a quick summary report"""
    summary = {
        "timestamp": datetime.now().isoformat(),
        "scan_summary": {
            "total": 1245,
            "critical": 23,
            "compliance": "99.8%"
        }
    }
    return jsonify(summary)

# ==================== MAIN ====================
if __name__ == '__main__':
    print("=" * 60)
    print("üöÄ DLP SECURITY SYSTEM")
    print("=" * 60)
    print("‚úÖ All pages with modern design")
    print("‚úÖ API endpoints working")
    print("‚úÖ Report download available")
    print("")
    print("üåê Access Points:")
    print("   Dashboard:     http://localhost:5000")
    print("   Scanner:       http://localhost:5000/scanner")
    print("   Monitor:       http://localhost:5000/monitor")
    print("   Alerts:        http://localhost:5000/alerts")
    print("   Reports:       http://localhost:5000/reports")
    print("   API Testing:   http://localhost:5000/api-testing")
    print("=" * 60)
    
    app.run(host='0.0.0.0', port=5000, debug=True)

# Documentation Pages
@app.route('/docs/scanner')
def scanner_docs():
    return render_template('scanner_docs.html')

@app.route('/docs/monitor')
def monitor_docs():
    return render_template('monitor_docs.html')

@app.route('/docs/policies')
def policies_docs():
    return render_template('policies_docs.html')

@app.route('/docs/dashboard')
def dashboard_docs():
    return render_template('dashboard_docs.html')

@app.route('/docs/api')
def api_docs():
    return render_template('api_docs.html')  # Your existing API docs

@app.route('/docs')
def docs_index():
    return render_template('docs_index.html')
